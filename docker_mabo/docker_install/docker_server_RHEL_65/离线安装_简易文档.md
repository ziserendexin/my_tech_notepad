### 0、核心指导

> https://www.cnblogs.com/haoxiaoyu/p/5e22e5838c10956c385d80d63255e66e.html#2.%20%E6%89%A7%E8%A1%8Cservice%20docker%20restart%E6%8A%A5%E5%A6%82%E4%B8%8B%E9%94%99%E8%AF%AF%EF%BC%9A

### 0.0、功能性说明

> https://stackoverflow.com/questions/34872129/how-to-install-docker-1-9-in-centos-6-5

因为内核2.6.x太过古董，缺少docker的选项，并且不稳定，所以，不能使用1.7.1以上版本的docker。

docker-compose问题：只能使用1.5.2。docker-compose也只能使用version：1的格式(甚至还不是全部)(人家v1都要求1.9+)，并且还有各种问题。

registry的风险：参考链接，总而言之，传递镜像不稳定。

> https://docs.docker.com/registry/compatibility/#registry-v23

Harbor：harbor使用v2+的docker-compose构建。so，1.7.1完全不能用。(自己实现一遍docker-compose？算了吧。)

所以通过此方式安装的东西，只能一切从简。

### 1、安装过程

复制`/install_rpm` 文件夹中的文件。

```
cd install_rpm
# 依次安装，一个个装。任何一个都有可能装出问题，所以慢一点。
rpm -ivh lxc-libs-1.0.11-1.el6.x86_64.rpm 
rpm -ivh lua-alt-getopt-0.7.0-1.el6.noarch.rpm 
rpm -ivh lua-filesystem-1.4.2-1.el6.x86_64.rpm 
rpm -ivh lua-lxc-1.0.11-1.el6.x86_64.rpm 
rpm -ivh lxc-1.0.11-1.el6.x86_64.rpm 
rpm -ivh libcgroup-0.40.rc1-24.el6_9.x86_64.rpm 
rpm -ivh docker-io-1.7.1-2.el6.x86_64.rpm 
```

### 2、docker启动&设置自启

启动docker

```
docker -d
# 或者 
/etc/init.d/cgconfig restart
service docker restart
```

设置开机自动启动

```
chkconfig --list docker
chkconfig --list cgconfig

chkconfig cgconfig on
chkconfig docker on
```



### 3、异常处理

#### a、运行`docker -d`命令报错如下：

```
# docker -d
INFO[0000] Listening for HTTP on unix (/var/run/docker.sock) 
WARN[0000] You are running linux kernel version 2.6.32-431.el6.x86_64, which might be unstable running docker. Please upgrade your kernel to 3.10.0. 
docker: relocation error: docker: symbol dm_task_get_info_with_deferred_remove, version Base not defined in file libdevmapper.so.1.02 with link time reference
```

进入device-mapper-libs目录，依此安装所有包。 

```
rpm -ivh  device-mapper***.rpm  –-force --nodeps
```

PS：也可以考虑用yum安装

```
yum localinstall *.rpm
```



### b、`docker -d`命令，报错如下（不需要，跳过）： 

```
FATA[0000] Error mounting devices cgroup: mountpoint for devices not found
```

```
# vi /etc/fstab
#在结尾添加
 none        /cgroup        cgroup        defaults    0    0
```

```
使之挂载生效
# mount -a
```

### c、 执行service docker restart报如下错误：

```
Starting cgconfig service: Error: cannot mount cpuset to /cgroup/cpuset: Device or resource busy
/sbin/cgconfigparser; error loading /etc/cgconfig.conf: Cgroup mounting failed
Failed to parse /etc/cgconfig.conf                           [FAILED]
```

（这个错误我按着搞了一遍，没效果，但重启以后就好了，可能是虚拟机的挂载？或者是其他。）

[也参考了链接中的方式]: https://stackoverflow.com/questions/25183063/docker-on-rhel-6-cgroup-mounting-failing

~~看顶部链接里面的吧。没搞懂的我就不写了。~~

```
# /etc/init.d/cgconfig status
# mkdir -p /cgroup/cpuacct /cgroup/memory /cgroup/devices /cgroup/freezer net_cls /cgroup/blkio
# cat /etc/cgconfig.conf |tail|grep "="|awk '{print "mount -t cgroup -o",$1,$1,$NF}'>cgroup_mount.sh
# sh ./cgroup_mount.sh
# /etc/init.d/cgconfig restart
# /etc/init.d/docker restart
```

这段代码的意思是，将

/etc/cgconfig.conf 目录下面的mount目录，给全部打开。

如下所示

```
# See man cgconfig.conf for further details.
#
# By default, mount all controllers to /cgroup/<controller>

mount {
	cpuset	= /cgroup/cpuset;
	cpu	= /cgroup/cpu;
	cpuacct	= /cgroup/cpuacct;
	memory	= /cgroup/memory;
	devices	= /cgroup/devices;
	freezer	= /cgroup/freezer;
	net_cls	= /cgroup/net_cls;
	blkio	= /cgroup/blkio;
}

[ziserendexin@ ~]$ 

```

然后启动docker就好了

```
/etc/init.d/cgconfig restart
/etc/init.d/docker restart
```

然后虚拟机上只能使用 service docker restart启动。不能使用docker -d的命令，一使用就重启。。。所以，我就不对116这么干了。





#### 4、加载registry镜像

```
# 在外部 打包镜像
docker save image:tag
```

加载镜像

```
docker load registry
# 1.7.1 要 在registry前加个 -i
```

### 5、run registry

不推荐使用docker-compose，太费功夫了，并且各种不支持。

```
docker run -d \
  -p 10051:5000 \
  --restart=always \
  --name registry \
  -v /usr/mabo/docker_server/registry:/var/lib/registry \
  registry:2.6.2
```

说明：

-p 10051:5000 ：暴露10051给外部。docker内部默认5000

-v /usr/mabo/docker_server/registry：使用这个目录，作为registry的持久化目录。(迁移的话，按理来说直接把这个目录copy过去就好了，maybe)

```
# test 
curl 10.7.0.116:10051/v2/_catalog
```



### 6、其他说明

关于权限，login，可以在配置文件中尝试配置，但我之前配置的各种不成功过，先。。。这样算了。

以后使用centos7或者RHEL7，使用Docker吧。别挣扎了。

#### 7、docker-compose

简单说下，docker-compose第一要使用，1.5.2版本，第二，需要升级glibc 到2.17。

- 1.5.2下载，请去官方刨祖坟。

- 升级glibc 请参考

> https://segmentfault.com/a/1190000011710031

- v3的compose文件降级？——出门右转，走好不送

### 8、其他遇到的问题&及处理方式

安装libcgroup的rpm时候，报被16版本阻止。

-使用yum安装升级。